---
title: "Case Studies analysis Ayala"
output: word_document
date: '2023-03-31'
---
File & Packages
```{r, message=FALSE}
# Packages
library(openxlsx)
library(ggplot2)
library(lavaan)
library(semTools)

# The files with the dataframe
file_name_2 = "/Users/ayaladenul/Desktop/Case Studies/Analyses/Data/dataset_study2_OSF.xlsx"
  ### Note: adapt the file path

# read in  data file
Data_Study2 <- read.xlsx(file_name_2)
```


Plots
1) Plots of single variables
For each variable the same plots and descriptive statistics are calculated
```{r}
### COMF = social comparison scale
COMF_plots <- ggplot(Data_Study2, aes(x=COMF))  # intialize ggplot
COMF_plots + geom_histogram(color="black", binwidth=5) + geom_vline(aes(xintercept=mean(COMF)), color="black", linewidth=1)   # histogram with mean
COMF_plots + geom_boxplot()   # boxplot
print(paste('COMF min: ', min(Data_Study2$COMF), sep=''))   # minimum
print(paste('COMF max: ', max(Data_Study2$COMF), sep=''))   # maximum
print(paste('COMF mean: ', round(mean(Data_Study2$COMF), digits=2), sep=''))  # mean
print(paste('COMF sd: ', round(sd(Data_Study2$COMF), digits=2), sep=''))  # standard deviation

### CSS = Contingent self-esteem scale
CSS_plots <- ggplot(Data_Study2, aes(x=CSS))
CSS_plots + geom_histogram(color="black", binwidth=5) + geom_vline(aes(xintercept=mean(CSS)), color="black", size=1)
CSS_plots + geom_boxplot()
print(paste('CSS min: ', min(Data_Study2$CSS), sep=''))
print(paste('CSS max: ', max(Data_Study2$CSS), sep=''))
print(paste('CSS mean: ', round(mean(Data_Study2$CSS), digits=2), sep=''))
print(paste('CSS sd: ', round(sd(Data_Study2$CSS), digits=2), sep=''))

### RSES = Global self-esteem scale
RSES_plots <- ggplot(Data_Study2, aes(x=RSES))
RSES_plots + geom_histogram(color="black", binwidth=5) + geom_vline(aes(xintercept=mean(RSES)), color="black", size=1)
RSES_plots + geom_histogram(color="black", binwidth=5) + geom_vline(aes(xintercept=mean(RSES)), color="black", size=1) 
RSES_plots + geom_boxplot()
print(paste('RSES min: ', min(Data_Study2$RSES), sep=''))
print(paste('RSES max: ', max(Data_Study2$RSES), sep=''))
print(paste('RSES mean: ', round(mean(Data_Study2$RSES), digits=2), sep=''))
print(paste('RSES sd: ', round(sd(Data_Study2$RSES), digits=2), sep=''))

### Depr: DASS-21 depression subscale
Depr_plots <- ggplot(Data_Study2, aes(x=DASS_depression))
Depr_plots + geom_histogram(color="black", binwidth=5) + geom_vline(aes(xintercept=mean(DASS_depression)), color="black", size=1)
Depr_plots + geom_histogram(color="black", binwidth=5) + geom_vline(aes(xintercept=mean(DASS_depression)), color="black", size=1) 
Depr_plots + geom_boxplot()
print(paste('Depr min: ', min(Data_Study2$DASS_depression), sep=''))
print(paste('Depr max: ', max(Data_Study2$DASS_depression), sep=''))
print(paste('Depr mean: ', round(mean(Data_Study2$DASS_depression), digits=2), sep=''))
print(paste('Depr sd: ', round(sd(Data_Study2$DASS_depression), digits=2), sep=''))
# Note: best to also repeat this for the anxiety and stress symptoms subscale of the DASS-21
```

2) Explore the relationships between 2 variables with plots
For the expected relationships between 2 variables, a plot is made
& a regression line (y~x) is added to each plot
```{r}
### Social comparison & contingent self-esteem
ggplot(Data_Study2, aes(x=COMF, y=CSS)) + geom_point() + geom_smooth(method = "lm", formula = y ~ x)  # positive relaltionship

### Social comparison & global self-esteem
ggplot(Data_Study2, aes(x=COMF, y=RSES)) + geom_point() + geom_smooth(method = "lm", formula = y ~ x)  # small negative relationship

### contingent self-esteem & global self-esteem
ggplot(Data_Study2, aes(x=CSS, y=RSES)) + geom_point() + geom_smooth(method = "lm", formula = y ~ x)  # negative relationship

### contingent self-esteem & depression symptoms
ggplot(Data_Study2, aes(x=CSS, y=DASS_depression)) + geom_point() + geom_smooth(method = "lm", formula = y ~ x)  # positive relationship

### contingent self-esteem & depression symptoms
ggplot(Data_Study2, aes(x=RSES, y=DASS_depression)) + geom_point() + geom_smooth(method = "lm", formula = y ~ x)  # negative relationship
```


Fitted several structural equation models (SEM)
SE were calculated using bootstrapping (see se='bootstrap')

1) First group of Models:
Models that include a direct effect of COMF (social comparison) on depression
```{r}
# Model 1
# COMF -> depression 
# COMF -> CSS -> depression
model1 <- '# direct effect
             DASS_depression ~ c*COMF
           # mediator
             CSS ~ a*COMF
             DASS_depression ~ b*CSS
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)'  # Specify the model
fit1 <- sem(model1, data = Data_Study2, se='bootstrap')   # fit the model using SEM 
summary(fit1)   # summary of the results

# Model 2: 
# COMF -> depression
# COMF -> RSES -> depression
model2 <- ' # direct effect
             DASS_depression ~ c*COMF
           # mediator
             RSES ~ a*COMF
             DASS_depression ~ b*RSES
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)'
fit2 <- sem(model2, data = Data_Study2, se='bootstrap')
summary(fit2)

# Model 3: 
# COMF -> depression 
# COMF -> CSS -> depression 
# COMF -> RSES -> depression
# COMF -> CSS -> RSES -> depression
model3 <- ' # direct effect
             DASS_depression ~ c*COMF
            # indirect effect 1
             CSS ~ a1*COMF
             DASS_depression ~ b1*CSS
            # indirect effect 2
             RSES ~ a2*COMF
             DASS_depression ~ b2*RSES
            # indirect effect 3 
             RSES ~ b3*CSS
            # indirect effect 1
             a1b1 := a1*b1
            # indirect effect 2
             a2b2 := a2*b2
            # indirect effect 3
             a1b3b2 := a1*b3*b2
           # total effect
             total := c + (a1*b1) + (a2*b2) + (a1*b3*b2)'
fit3 <- sem(model3, data = Data_Study2, se='bootstrap')
summary(fit3)
```

Calculate fit indices to compare models
```{r}
fit1_indices <- fitMeasures(fit1, fit.measures=c('chisq','df','cfi','rmsea','aic','bic'))
fit2_indices <- fitMeasures(fit2, fit.measures=c('chisq','df','cfi','rmsea','aic','bic'))
fit3_indices <- fitMeasures(fit3, fit.measures=c('chisq','df','cfi','rmsea','aic','bic'))
FitIndices_all <- data.frame(rbind(fit1_indices,fit2_indices,fit3_indices)) 
print(FitIndices_all)
  # look at lowest aic & bic?
```

2) Second group of Models:
Models without a direct effect of COMF (social comparison) on depression
```{r}
# Model 4: 
# COMF -> CSS -> depression
model4 <- '# mediator
             CSS ~ a*COMF
             DASS_depression ~ b*CSS
           # total effect
             total := (a*b)'
fit4 <- sem(model4, data = Data_Study2, se='bootstrap')
summary(fit4)

# Model 5: 
# COMF -> RSES -> depression
model5 <- '# mediator
             RSES ~ a*COMF
             DASS_depression ~ b*RSES
           # total effect
             total := (a*b)'

fit5 <- sem(model5, data = Data_Study2, se='bootstrap')
summary(fit5)

# Model 6: 
# COMF -> CSS -> RSES -> depression
model6 <- '# indirect effect 1
             CSS ~ a1*COMF
            # indirect effect 2
             DASS_depression ~ b2*RSES
            # indirect effect 3 
             RSES ~ b3*CSS
           # total effect
             total := (a1*b3*b2)'
fit6 <- sem(model6, data = Data_Study2, se='bootstrap')
summary(fit6)
```

Compare models
First: you can compare nested models using the likelihood ratio test
Second: calculate fit indices to compare the non-nested models
```{r}
# log-likelihood values
LL1 <- summary(fit1)$logLik
LL2 <- summary(fit4)$logLik
# Perform the likelihood ratio test
LRtest <- anova(fit1, fit4)
# Print the results
print(LRtest)

# log-likelihood values
LL1 <- summary(fit2)$logLik
LL2 <- summary(fit5)$logLik
# Perform the likelihood ratio test
LRtest <- anova(fit2, fit5)
# Print the results
print(LRtest)

# log-likelihood values
LL1 <- summary(fit3)$logLik
LL2 <- summary(fit6)$logLik
# Perform the likelihood ratio test
LRtest <- anova(fit3, fit6)
# Print the results
print(LRtest)


# Calculate fit indices to compare models 
fit4_indices <- fitMeasures(fit4, fit.measures=c('chisq','df','cfi','rmsea','aic','bic'))
fit5_indices <- fitMeasures(fit5, fit.measures=c('chisq','df','cfi','rmsea','aic','bic'))
fit6_indices <- fitMeasures(fit6, fit.measures=c('chisq','df','cfi','rmsea','aic','bic'))
FitIndices_all <- data.frame(rbind(fit4_indices,fit5_indices,fit6_indices))
print(FitIndices_all)
  # look at lowest aic & bic?
```

Conclusions: 
H0 of the likelihood ratio test: the more complex model does not fit the data significantly better than the simpler model
Ha: the more complex model does fit the data significantly bette

p-values are greater than 0.05 significance level: fail to reject the null hypothesis 
and conclude that there is not enough evidence to suggest that the complex models provide a significantly better fit to the data than the simpler models
Therefore, choose the simpler models over the more complex models for each test


Comparing the fit indices of the simpler models:
Main difference in aic and bic
lowest values: model5
So, choose model 5 over the other models


However, I am unsure if the comparison techniques are correct 
and if the models are correctly specified
